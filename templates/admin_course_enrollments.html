{% extends "base.html" %}
{% block title %}Admin - Course Enrollments{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Page Header -->
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <h1 class="h3 mb-0 text-gray-800">
            <i class="fas fa-user-graduate mr-2"></i>Course Enrollments Management
        </h1>
    </div>

    <!-- Course Information Card -->
    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">
                <i class="fas fa-info-circle mr-2"></i>Course Information
            </h6>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <h5>{{ course.code }} - {{ course.name }}</h5>
                    <p class="text-muted">{{ course.description }}</p>
                    <p><strong>Lecturer:</strong> {{ course.lecturer.user.name }}</p>
                    <p><strong>Semester:</strong> {{ course.semester }}</p>
                </div>
                <div class="col-md-6">
                    <div class="row">
                        <div class="col-6">
                            <div class="card border-left-primary shadow h-100 py-2">
                                <div class="card-body">
                                    <div class="row no-gutters align-items-center">
                                        <div class="col mr-2">
                                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                                Enrolled Students
                                            </div>
                                            <div class="h5 mb-0 font-weight-bold text-gray-800 enrollment-count">
                                                {{ enrolled_students|length }} / {{ course.max_capacity }}
                                            </div>
                                        </div>
                                        <div class="col-auto">
                                            <i class="fas fa-users fa-2x text-gray-300"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="mt-3">
                        {% set percentage = (enrolled_students|length / course.max_capacity * 100) if course.max_capacity > 0 else 0 %}
                        {% set percentage_int = percentage|round|int %}
                        <div class="progress">
                            <div class="progress-bar 
                                {% if percentage >= 90 %}
                                    bg-danger
                                {% elif percentage >= 75 %}
                                    bg-warning
                                {% else %}
                                    bg-success
                                {% endif %}" 
                                role="progressbar" 
                                style="width: '{{ percentage_int }}''%' "
                                aria-valuenow="{{ enrolled_students|length }}" 
                                aria-valuemin="0" 
                                aria-valuemax="{{ course.max_capacity }}">
                                {{ percentage_int }}% Full
                            </div>
                        </div>
                        <small class="text-muted">Capacity: {{ enrolled_students|length }} / {{ course.max_capacity }} students</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Two Column Layout -->
    <div class="row">
        <!-- Left Column: Enrolled Students -->
        <div class="col-lg-6">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="fas fa-user-check mr-2"></i>Enrolled Students ({{ enrolled_students|length }})
                    </h6>
                </div>
                <div class="card-body">
                    {% if enrolled_students %}
                    <div class="table-responsive">
                        <table class="table table-bordered" id="enrolledTable" width="100%" cellspacing="0">
                            <thead>
                                <tr>
                                    <th>Student ID</th>
                                    <th>Name</th>
                                    <th>Major</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for student in enrolled_students %}
                                <tr id="student-{{ student.id }}">
                                    <td>{{ student.student_id }}</td>
                                    <td>{{ student.user.name }}</td>
                                    <td>{{ student.major }}</td>
                                    <td>
                                        <button onclick="unenrollStudent('{{ student.id }}')" 
                                                class="btn btn-danger btn-sm" 
                                                title="Remove from course">
                                            <i class="fas fa-user-minus"></i>
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-user-slash fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">No students enrolled in this course</h5>
                        <p class="text-muted">Add students using the form on the right</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Right Column: Add Students -->
        <div class="col-lg-6">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="fas fa-user-plus mr-2"></i>Add Students to Course
                    </h6>
                </div>
                <div class="card-body">
                    <!-- Search and Filter Section -->
                    <div class="row mb-4">
                        <div class="col-md-12">
                            <div class="input-group">
                                <input type="text" id="studentSearch" class="form-control" 
                                       placeholder="Search students by name or ID..." 
                                       onkeyup="filterStudents()">
                                <div class="input-group-append">
                                    <button class="btn btn-outline-secondary" type="button" onclick="filterStudents()">
                                        <i class="fas fa-search"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Available Students Table -->
                    <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                        <table class="table table-hover" id="availableTable" width="100%" cellspacing="0">
                            <thead class="bg-light">
                                <tr>
                                    <th>Student ID</th>
                                    <th>Name</th>
                                    <th>Major</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="availableStudentsBody">
                                {% for student in available_students %}
                                <tr id="available-{{ student.id }}">
                                    <td>{{ student.student_id }}</td>
                                    <td>{{ student.user.name }}</td>
                                    <td>{{ student.major }}</td>
                                    <td>
                                        <button onclick="enrollStudent('{{ student.id }}')" 
                                                class="btn btn-success btn-sm"
                                                title="Add to course">
                                            <i class="fas fa-plus"></i> Add
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    {% if not available_students %}
                    <div class="text-center py-4">
                        <i class="fas fa-check-circle fa-3x text-success mb-3"></i>
                        <h5 class="text-muted">All students are enrolled in this course</h5>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Back Button -->
    <div class="row">
        <div class="col-12">
            <a href="{{ url_for('admin_courses') }}" class="btn btn-secondary">
                <i class="fas fa-arrow-left mr-1"></i> Back to Courses
            </a>
        </div>
    </div>
</div>

<!-- Confirmation Modal -->
<div class="modal fade" id="confirmationModal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="confirmationTitle"></h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body" id="confirmationMessage">
                <!-- Message will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirmActionButton">Confirm</button>
            </div>
        </div>
    </div>
</div>

<script>
// Global variables
const courseId = '{{ course.id }}';
const maxCapacity = '{{ course.max_capacity }}';
let currentEnrollmentCount = '{{ enrolled_students|length }}';

// Initialize DataTable for enrolled students
$(document).ready(function() {
    $('#enrolledTable').DataTable({
        "pageLength": 10,
        "ordering": true,
        "order": [[1, 'asc']],
        "language": {
            "emptyTable": "No students enrolled",
            "search": "Search enrolled students:"
        }
    });
});

// Filter available students
function filterStudents() {
    const searchText = $('#studentSearch').val().toLowerCase();
    
    $('#availableStudentsBody tr').each(function() {
        const studentId = $(this).find('td:eq(0)').text().toLowerCase();
        const studentName = $(this).find('td:eq(1)').text().toLowerCase();
        const studentMajor = $(this).find('td:eq(2)').text().toLowerCase();
        
        const matchesSearch = studentId.includes(searchText) || 
                             studentName.includes(searchText) || 
                             studentMajor.includes(searchText);
        
        if (matchesSearch) {
            $(this).show();
        } else {
            $(this).hide();
        }
    });
}

// Enroll a single student
function enrollStudent(studentId) {
    const studentRow = $('#available-' + studentId);
    const studentName = studentRow.find('td:eq(1)').text();
    
    if (currentEnrollmentCount >= maxCapacity) {
        alert('Course has reached maximum capacity!');
        return;
    }
    
    showConfirmation(
        'Enroll ' + studentName + '?',
        'Are you sure you want to enroll ' + studentName + ' in this course?',
        function() {
            $.ajax({
                url: '/admin/courses/enroll',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    course_id: courseId,
                    student_id: studentId
                }),
                success: function(response) {
                    if (response.success) {
                        // Move student from available to enrolled table
                        const studentData = studentRow.find('td');
                        
                        // Remove from available table
                        studentRow.remove();
                        
                        // Add to enrolled table
                        const newRow = '<tr id="student-' + studentId + '">' +
                            '<td>' + studentData.eq(0).text() + '</td>' +
                            '<td>' + studentData.eq(1).text() + '</td>' +
                            '<td>' + studentData.eq(2).text() + '</td>' +
                            '<td>' +
                                '<button onclick="unenrollStudent(' + studentId + ')" ' +
                                        'class="btn btn-danger btn-sm">' +
                                    '<i class="fas fa-user-minus"></i>' +
                                '</button>' +
                            '</td>' +
                        '</tr>';
                        
                        $('#enrolledTable tbody').append(newRow);
                        currentEnrollmentCount++;
                        updateCapacityProgress();
                        
                        // Update DataTable
                        $('#enrolledTable').DataTable().draw();
                        
                        alert(studentName + ' enrolled successfully!');
                        // Reload page to refresh data
                        setTimeout(function() {
                            location.reload();
                        }, 1000);
                    } else {
                        alert('Error: ' + (response.message || 'Failed to enroll student'));
                    }
                },
                error: function() {
                    alert('Error enrolling student. Please try again.');
                }
            });
        }
    );
}

// Unenroll a student
function unenrollStudent(studentId) {
    const studentRow = $('#student-' + studentId);
    const studentName = studentRow.find('td:eq(1)').text();
    
    showConfirmation(
        'Remove ' + studentName + '?',
        'Are you sure you want to remove ' + studentName + ' from this course?',
        function() {
            $.ajax({
                url: '/admin/courses/unenroll',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    course_id: courseId,
                    student_id: studentId
                }),
                success: function(response) {
                    if (response.success) {
                        // Remove from enrolled table
                        studentRow.remove();
                        currentEnrollmentCount--;
                        updateCapacityProgress();
                        
                        // Update DataTable
                        $('#enrolledTable').DataTable().draw();
                        
                        alert(studentName + ' removed from course successfully!');
                        // Reload page to refresh data
                        setTimeout(function() {
                            location.reload();
                        }, 1000);
                    } else {
                        alert('Error: ' + (response.message || 'Failed to remove student'));
                    }
                },
                error: function() {
                    alert('Error removing student. Please try again.');
                }
            });
        }
    );
}

// Update capacity progress bar
function updateCapacityProgress() {
    const percentage = (currentEnrollmentCount / maxCapacity) * 100;
    const percentageInt = Math.round(percentage);
    const progressBar = $('.progress-bar');
    
    progressBar.css('width', percentageInt + '%');
    progressBar.attr('aria-valuenow', currentEnrollmentCount);
    progressBar.text(percentageInt + '% Full');
    
    // Update color based on capacity
    if (percentage >= 90) {
        progressBar.removeClass('bg-success bg-warning').addClass('bg-danger');
    } else if (percentage >= 75) {
        progressBar.removeClass('bg-success bg-danger').addClass('bg-warning');
    } else {
        progressBar.removeClass('bg-warning bg-danger').addClass('bg-success');
    }
    
    // Update enrollment count display
    $('.enrollment-count').text(currentEnrollmentCount + ' / ' + maxCapacity);
}

// Show confirmation modal
function showConfirmation(title, message, confirmCallback) {
    $('#confirmationTitle').text(title);
    $('#confirmationMessage').text(message);
    $('#confirmActionButton').off('click').on('click', confirmCallback);
    $('#confirmationModal').modal('show');
}
</script>

<style>
.card {
    margin-bottom: 1.5rem;
    border: 1px solid #e3e6f0;
    border-radius: 0.35rem;
}

.card-header {
    background-color: #f8f9fc;
    border-bottom: 1px solid #e3e6f0;
}

.table th {
    background-color: #f8f9fa;
    border-top: none;
}

.progress {
    height: 1.5rem;
    border-radius: 0.35rem;
}

.progress-bar {
    font-size: 0.85rem;
    font-weight: 600;
}

.btn-sm {
    padding: 0.25rem 0.5rem;
    font-size: 0.875rem;
}

.table-responsive::-webkit-scrollbar {
    width: 8px;
    height: 8px;
}

.table-responsive::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 4px;
}

.table-responsive::-webkit-scrollbar-thumb {
    background: #888;
    border-radius: 4px;
}

.table-responsive::-webkit-scrollbar-thumb:hover {
    background: #555;
}

.table-hover tbody tr:hover {
    background-color: rgba(0, 0, 0, 0.075);
}

@media (max-width: 768px) {
    .table-responsive {
        font-size: 0.875rem;
    }
}
</style>
{% endblock %}