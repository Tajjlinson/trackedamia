{% extends "base.html" %}

{% block title %}Create Session{% endblock %}

{% block content %}
<div class="dashboard-header">
    <h1><i class="fas fa-calendar-plus"></i> Create New Session</h1>
    <p>Schedule a new class session with location tracking</p>
</div>

<div class="form-container">
    {% if error %}
    <div class="alert alert-danger">
        <i class="fas fa-exclamation-circle"></i> {{ error }}
    </div>
    {% endif %}
    
    <form method="POST" action="{{ url_for('create_session') }}">
        <div class="form-row">
            <div class="form-group">
                <label for="course_id"><i class="fas fa-book"></i> Course</label>
                <select id="course_id" name="course_id" class="form-control" required>
                    <option value="">Select a course</option>
                    {% for course in courses %}
                    <option value="{{ course.id }}">{{ course.code }} - {{ course.name }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="form-group">
                <label for="session_name"><i class="fas fa-heading"></i> Session Name</label>
                <input type="text" id="session_name" name="session_name" class="form-control" 
                       placeholder="e.g., Lecture 1: Introduction" required>
            </div>
        </div>
        
        <div class="form-row">
            <div class="form-group">
                <label for="date"><i class="fas fa-calendar"></i> Date</label>
                <input type="date" id="date" name="date" class="form-control" required 
                       value="{{ today }}">
            </div>
            
            <div class="form-group">
                <label for="start_time"><i class="fas fa-clock"></i> Start Time</label>
                <input type="time" id="start_time" name="start_time" class="form-control" 
                       value="09:00" required>
            </div>
            
            <div class="form-group">
                <label for="duration"><i class="fas fa-hourglass-half"></i> Duration (minutes)</label>
                <input type="number" id="duration" name="duration" class="form-control" 
                       value="90" min="30" max="240" required>
            </div>
        </div>
        
        <div class="form-group">
            <label for="location"><i class="fas fa-location-dot"></i> Lecture Room Location</label>
            <input type="text" id="location" name="location" class="form-control" 
                   placeholder="e.g., Room 101, Main Building" required>
        </div>
        
        <!-- Location Capture Card -->
        <div class="card" style="margin-bottom: 20px; border-left: 4px solid #3b82f6;">
            <div class="card-header" style="background-color: #f8fafc; border-bottom: 1px solid #e2e8f0;">
                <h3 style="margin: 0; color: #1e293b; font-size: 1.1rem;">
                    <i class="fas fa-map-marker-alt" style="color: #3b82f6; margin-right: 8px;"></i>
                    Location Coordinates
                </h3>
                <p style="margin: 5px 0 0 0; color: #64748b; font-size: 0.9rem;">
                    Required for attendance verification
                </p>
            </div>
            <div class="card-body" style="padding: 20px;">
                <div class="form-group" style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 500; color: #334155;">
                        <i class="fas fa-crosshairs"></i> Capture Current Location
                    </label>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <button type="button" id="getLocationBtn" class="btn btn-secondary" 
                                style="background-color: #6b7280; border-color: #6b7280;">
                            <i class="fas fa-location-dot"></i> Use My Current Location
                        </button>
                        <span style="font-size: 0.9rem; color: #64748b;">
                            Click when you're in the lecture room
                        </span>
                    </div>
                </div>
                
                <!-- Hidden fields for coordinates -->
                <input type="hidden" id="latitude" name="latitude">
                <input type="hidden" id="longitude" name="longitude">
                
                <!-- Location Status Display -->
                <div id="location-status" style="display: none;">
                    <div style="display: flex; align-items: center; gap: 10px; padding: 12px; 
                                background-color: #ecfdf5; border-radius: 8px; border: 1px solid #a7f3d0;">
                        <i class="fas fa-check-circle" style="color: #10b981; font-size: 1.2rem;"></i>
                        <div>
                            <div style="font-weight: 500; color: #065f46;">Location Captured Successfully</div>
                            <div id="coordinates-text" style="font-size: 0.9rem; color: #047857; font-family: monospace;"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Location Error Display -->
                <div id="location-error" style="display: none;">
                    <div style="display: flex; align-items: center; gap: 10px; padding: 12px; 
                                background-color: #fef2f2; border-radius: 8px; border: 1px solid #fecaca;">
                        <i class="fas fa-exclamation-triangle" style="color: #dc2626; font-size: 1.2rem;"></i>
                        <div>
                            <div style="font-weight: 500; color: #7f1d1d;" id="error-title">Location Error</div>
                            <div id="error-message" style="font-size: 0.9rem; color: #991b1b;"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="form-row">
            <div class="form-group">
                <label for="allowed_distance_meters">
                    <i class="fas fa-ruler"></i> Allowed Distance (meters)
                </label>
                <input type="number" id="allowed_distance_meters" name="allowed_distance_meters" 
                       class="form-control" value="50" min="10" max="500" required>
                <small class="form-help">
                    How far from the lecture room students can mark attendance
                </small>
            </div>
            
            <div class="form-group">
                <label for="allowed_ip_range">
                    <i class="fas fa-network-wired"></i> Allowed Network (Optional)
                </label>
                <input type="text" id="allowed_ip_range" name="allowed_ip_range" 
                       class="form-control" placeholder="e.g., 192.168.1.0/24">
                <small class="form-help">
                    Restrict to specific IP range (leave blank for any network)
                </small>
            </div>
        </div>
        
        <div class="form-actions">
            <button type="submit" class="btn btn-primary">
                <i class="fas fa-save"></i> Create Session
            </button>
            <a href="{{ url_for('my_sessions') }}" class="btn btn-secondary">
                <i class="fas fa-times"></i> Cancel
            </a>
        </div>
    </form>
</div>

<script>
// Set today's date as default
document.addEventListener('DOMContentLoaded', function() {
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('date').value = today;
    
    // Setup location button
    const getLocationBtn = document.getElementById('getLocationBtn');
    if (getLocationBtn) {
        getLocationBtn.addEventListener('click', getCurrentLocation);
    }
});

function getCurrentLocation() {
    if (!navigator.geolocation) {
        showLocationError(
            "Browser Not Supported", 
            "Your browser does not support geolocation. Please use a modern browser."
        );
        return;
    }
    
    const button = document.getElementById('getLocationBtn');
    if (!button) return;
    
    // Save original button state
    const originalText = button.innerHTML;
    const originalColor = button.style.backgroundColor;
    
    // Update button to loading state
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Getting Location...';
    button.disabled = true;
    button.style.backgroundColor = '#9ca3af';
    
    // Hide any previous messages
    document.getElementById('location-status').style.display = 'none';
    document.getElementById('location-error').style.display = 'none';
    
    navigator.geolocation.getCurrentPosition(
        // Success callback
        function(position) {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            const accuracy = position.coords.accuracy;
            
            console.log(`Location captured: ${lat}, ${lng} (Accuracy: ${accuracy}m)`);
            
            // Set hidden fields
            document.getElementById('latitude').value = lat;
            document.getElementById('longitude').value = lng;
            
            // Update location field with approximate info
            const locationField = document.getElementById('location');
            if (!locationField.value) {
                locationField.value = `Coordinates: ${lat.toFixed(6)}, ${lng.toFixed(6)}`;
            }
            
            // Show success message
            const coordsText = document.getElementById('coordinates-text');
            coordsText.textContent = `Lat: ${lat.toFixed(6)}, Lng: ${lng.toFixed(6)} (Accuracy: Â±${Math.round(accuracy)}m)`;
            document.getElementById('location-status').style.display = 'block';
            
            // Reset button after success
            button.innerHTML = '<i class="fas fa-check-circle"></i> Location Captured';
            button.style.backgroundColor = '#10b981';
            
            // Keep button green for 3 seconds, then reset
            setTimeout(() => {
                button.innerHTML = originalText;
                button.disabled = false;
                button.style.backgroundColor = originalColor;
            }, 3000);
        },
        
        // Error callback
        function(error) {
            let errorTitle = "Location Error";
            let errorMessage = "";
            
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    errorTitle = "Permission Denied";
                    errorMessage = "Please allow location access in your browser settings. " +
                                 "Click the lock icon in the address bar and enable location permissions.";
                    break;
                case error.POSITION_UNAVAILABLE:
                    errorTitle = "Location Unavailable";
                    errorMessage = "Your location could not be determined. " +
                                 "Check your internet connection and GPS/Wi-Fi settings.";
                    break;
                case error.TIMEOUT:
                    errorTitle = "Request Timeout";
                    errorMessage = "Location request took too long. Please try again.";
                    break;
                default:
                    errorMessage = "An unknown error occurred while getting your location.";
            }
            
            showLocationError(errorTitle, errorMessage);
            
            // Reset button
            button.innerHTML = originalText;
            button.disabled = false;
            button.style.backgroundColor = originalColor;
        },
        
        // Options
        {
            enableHighAccuracy: true,
            timeout: 15000,
            maximumAge: 0
        }
    );
}

function showLocationError(title, message) {
    document.getElementById('error-title').textContent = title;
    document.getElementById('error-message').textContent = message;
    document.getElementById('location-error').style.display = 'block';
}
</script>

<style>
.form-container {
    max-width: 800px;
    margin: 0 auto;
    background: white;
    border-radius: 12px;
    padding: 30px;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
}

.form-row {
    display: flex;
    gap: 20px;
    margin-bottom: 20px;
}

.form-row .form-group {
    flex: 1;
}

.form-group {
    margin-bottom: 20px;
}

.form-group label {
    display: block;
    margin-bottom: 8px;
    font-weight: 500;
    color: #374151;
}

.form-control {
    width: 100%;
    padding: 10px 12px;
    border: 1px solid #d1d5db;
    border-radius: 8px;
    font-size: 0.95rem;
    transition: border-color 0.2s;
}

.form-control:focus {
    outline: none;
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.form-help {
    display: block;
    margin-top: 6px;
    font-size: 0.85rem;
    color: #6b7280;
}

.form-actions {
    display: flex;
    gap: 12px;
    margin-top: 30px;
    padding-top: 20px;
    border-top: 1px solid #e5e7eb;
}

.btn {
    padding: 10px 20px;
    border: none;
    border-radius: 8px;
    font-size: 0.95rem;
    font-weight: 500;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    transition: all 0.2s;
    text-decoration: none;
}

.btn-primary {
    background-color: #3b82f6;
    color: white;
}

.btn-primary:hover {
    background-color: #2563eb;
}

.btn-secondary {
    background-color: #6b7280;
    color: white;
}

.btn-secondary:hover {
    background-color: #4b5563;
}

.btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}

.alert {
    padding: 12px 16px;
    border-radius: 8px;
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    gap: 10px;
}

.alert-danger {
    background-color: #fef2f2;
    border: 1px solid #fecaca;
    color: #dc2626;
}

.card {
    background: white;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
}

.card-header {
    padding: 16px 20px;
}

.card-body {
    padding: 20px;
}
</style>
{% endblock %}