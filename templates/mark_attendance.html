{% extends "base.html" %}

{% block title %}Mark Attendance{% endblock %}

{% block content %}
<div class="dashboard-header">
    <h1><i class="fas fa-check-circle"></i> Mark Attendance</h1>
    <p>Available active sessions for attendance marking</p>
</div>

<div class="table-container">
    {% if sessions %}
    <table>
        <thead>
            <tr>
                <th>Session Name</th>
                <th>Course</th>
                <th>Location</th>
                <th>Time</th>
                <th>Status</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody>
            {% for session in sessions %}
            <tr>
                <td>{{ session.name }}</td>
                <td>{{ session.course_name }}</td>
                <td>{{ session.location }}</td>
                <td>
                    {% if session.marked_time %}
                    {{ session.marked_time.strftime('%I:%M %p') }}
                    {% endif %}
                </td>
                <td>
                    {% if session.already_marked %}
                    <span class="status-badge" style="background-color: #dcfce7; color: #166534;">
                        <i class="fas fa-check"></i> Marked
                    </span>
                    {% else %}
                    <span class="status-badge" style="background-color: #fef3c7; color: #92400e;">
                        <i class="fas fa-clock"></i> Pending
                    </span>
                    {% endif %}
                </td>
                <td>
                    {% if not session.already_marked %}
                    <button onclick="markAttendance('{{ session.id }}')" class="btn btn-primary btn-sm">
                        <i class="fas fa-location-dot"></i> Mark Attendance
                    </button>
                    {% else %}
                    <span style="color: #64748b;">Attendance already marked</span>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <div style="text-align: center; padding: 40px;">
        <i class="fas fa-calendar-times" style="font-size: 48px; color: #cbd5e1; margin-bottom: 20px;"></i>
        <h3>No Active Sessions</h3>
        <p style="color: #64748b;">There are no active sessions available for attendance marking at this time.</p>
    </div>
    {% endif %}
</div>
{% endblock %}

<!-- In mark_attendance.html, update the JavaScript -->
<script>
async function markAttendance(sessionId) {
    try {
        // Ask for location permission
        const position = await new Promise((resolve, reject) => {
            navigator.geolocation.getCurrentPosition(resolve, reject, {
                enableHighAccuracy: true,
                timeout: 10000
            });
        });
        
        const locationData = {
            latitude: position.coords.latitude,
            longitude: position.coords.longitude,
            accuracy: position.coords.accuracy
        };
        
        // Show loading
        const button = event.target;
        button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Checking location...';
        button.disabled = true;
        
        // Send to server
        const response = await fetch('/api/attendance/mark', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                session_id: sessionId,
                ...locationData
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert(`✅ ${result.message}`);
            location.reload();
        } else {
            alert(`❌ ${result.message}`);
            button.innerHTML = '<i class="fas fa-location-dot"></i> Try Again';
            button.disabled = false;
        }
        
    } catch (error) {
        alert(`Location error: ${error.message || error}`);
        event.target.innerHTML = '<i class="fas fa-location-dot"></i> Mark Attendance';
        event.target.disabled = false;
    }
}
</script>